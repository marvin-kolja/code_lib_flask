{% extends 'base.html' %}

{% block css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/scan.css') }}">
{% endblock %}

{% block head %}
<title>Scan Card</title>
{% endblock %}

{% block body %}
<h2>Scan a Card</h2>
<p>Scan your choosen Card.</p>
<p></p>
<p>The system will give you feedback if the card is working.</p>

<div id="box" class="box box-scanner-info">
    <strong>Ready!</strong> The Scanner is ready for scanning a Card.
</div>

<form action = "/scan" method = "post">
    <p id="back"><input onclick="abortFunction()" type = "submit" name = "back" value = "Back"/></p>
</form>

<script>
const sleep = (milliseconds) => {
  return new Promise(resolve => setTimeout(resolve, milliseconds))
}

var alertError = '<strong>Failed!</strong> The scanning failed! Please report it to the Team.'
var alertSuccess = '<strong>Success!</strong> You Card was recognized. Hang on second.'
var alertInfo =  ''

function loadScanner() {
    var xhttp = new XMLHttpRequest();

    xhttp.addEventListener("abort", transferCanceled);

    xhttp.open("GET", "/getid", true);

    xhttp.responseType = 'json';

    xhttp.onreadystatechange = function() {
        if (this.readyState == 4 && this.status == 200) {
            var responseObj = xhttp.response;
        
            document.getElementById("back").innerHTML = '<input onclick="abortFunction()" type = "submit" name = "back" value = "Back" disabled />';

            if (responseObj.code == '0x1') {
                // alert scan succesfull

                document.getElementById("box").classList.remove("box-scanner-info")
                document.getElementById("box").classList.add("box-scanner-success")

                document.getElementById("box").innerHTML = alertSuccess
                sleep(1000)
                loadCheck()
            }
            if (responseObj.code == '0x0') {
                // alert scanner error
                alert("Something went wrong with the scanner! Try again...")
                // Should report it to library team
                loadScanner()
            }
            // if (responseObj.code == '0x2') {
            //     alert("Timeout...")
            //     abortFunction()
            // }

        }
    };
    function transferCanceled(evt) {
        alert("The transfer has been canceled by the user.");
    }
    xhttp.send();

    function abortFunction() {
        xhttp.abort()
    }
    
}
function loadCheck() {
    var xhttp = new XMLHttpRequest();

    xhttp.addEventListener("abort", transferCanceled);

    xhttp.open("GET", "/checkData", true);

    xhttp.responseType = 'json';

    xhttp.onreadystatechange = function() {
        if (this.readyState == 4 && this.status == 200) {
            var responseObj = xhttp.response;
            if (responseObj.code == '1x0') {
                // alert User is already connected with this ID
                alert("The scanned ID is already connected to a user!")
            }
            if (responseObj.code == '1x1') {
                // alert Book is already connected with this ID
                alert("The scanned ID is already connected to a book!")
                
            }
            if (responseObj.code == '1x2') {
                window.location = "/signup/form";
            }
            if (responseObj.code == '1x3') {
                alert("There is no ID found...Something crucial went wrong! Please find help at the Library Team")
                window.location = "/";
            }
        }
    };
    // xhttp.onload = function() {

    // };
    function transferCanceled(evt) {
        alert("The transfer has been canceled by the user.");
    }
    xhttp.send();

    function abortFunction() {
        xhttp.abort()
    }
}
loadScanner()
</script>
{% endblock %}